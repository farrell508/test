<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modern Clock</title>
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <!-- Magnet Container -->
  <div class="magnet-container" id="magnetContainer"></div>

  <!-- 왼쪽 위: 기타 사유 패널 -->
  <div id="reasonPanel"
       style="position:fixed; left:40px; top:40px; width:320px; max-height:320px; overflow:auto;
              background: rgba(20,20,20,0.9); border:1px solid rgba(255,255,255,0.15);
              border-radius:12px; padding:14px; color:#fff; z-index:1000;">
    <div style="font-size:16px; font-weight:700; margin-bottom:8px;">기타 사유</div>
    <div id="reasonList" style="display:flex; flex-direction:column; gap:8px; font-size:14px; line-height:1.5;">
      <!-- 여기 자동으로 채워짐 -->
    </div>
  </div>

  <!-- Board Container -->
  <div class="board-container">
    <div class="board-title">상태창</div>
    <div class="board-grid">
      <div class="board-section" data-category="toilet">
        <div class="section-title">화장실(물)</div>
        <div class="section-content" id="toilet-content"></div>
      </div>
      <div class="board-section" data-category="hallway">
        <div class="section-title">복도</div>
        <div class="section-content" id="hallway-content"></div>
      </div>
      <div class="board-section" data-category="club">
        <div class="section-title">동아리</div>
        <div class="section-content" id="club-content"></div>
      </div>
      <div class="board-section" data-category="afterschool">
        <div class="section-title">방과후</div>
        <div class="section-content" id="afterschool-content"></div>
      </div>
      <div class="board-section" data-category="etc">
        <div class="section-title">기타</div>
        <div class="section-content" id="etc-content"></div>
      </div>
      <div class="board-section" data-category="absence">
        <div class="section-title">결석(조퇴)</div>
        <div class="section-content" id="absence-content"></div>
      </div>
    </div>
  </div>

  <!-- Clock -->
  <div class="clock-container">
    <div class="analog-clock">
      <div class="clock-center"></div>
      <div class="hand hour-hand" id="hourHand"></div>
      <div class="hand minute-hand" id="minuteHand"></div>
      <div class="hand second-hand" id="secondHand"></div>
      <!-- Hour markers -->
      <div class="marker major" style="transform: translateX(-50%) rotate(0deg);"></div>
      <div class="marker" style="transform: translateX(-50%) rotate(30deg);"></div>
      <div class="marker" style="transform: translateX(-50%) rotate(60deg);"></div>
      <div class="marker major" style="transform: translateX(-50%) rotate(90deg);"></div>
      <div class="marker" style="transform: translateX(-50%) rotate(120deg);"></div>
      <div class="marker" style="transform: translateX(-50%) rotate(150deg);"></div>
      <div class="marker major" style="transform: translateX(-50%) rotate(180deg);"></div>
      <div class="marker" style="transform: translateX(-50%) rotate(210deg);"></div>
      <div class="marker" style="transform: translateX(-50%) rotate(240deg);"></div>
      <div class="marker major" style="transform: translateX(-50%) rotate(270deg);"></div>
      <div class="marker" style="transform: translateX(-50%) rotate(300deg);"></div>
      <div class="marker" style="transform: translateX(-50%) rotate(330deg);"></div>
    </div>

    <div class="digital-clock">
      <div class="time-display">
        <span id="hours">00</span>:<span id="minutes">00</span><span class="seconds" id="seconds">00</span>
      </div>
      <div class="date-display" id="date">MONDAY, JANUARY 1</div>
      <div class="tstat" id="tstat">
    </div>
  </div>

  <!-- Attendance Info -->
  <div class="attendance-info">
    <div><span class="label">총원</span><span class="number" id="total-count">30명</span></div>
    <div><span class="label">결원</span><span class="number absent-count" id="absent-count">0명</span></div>
    <div><span class="label">현원</span><span class="number" id="present-count">30명</span></div>
  </div>

  <!-- Fullscreen Buttons -->
  <button class="fullscreen-btn" onclick="toggleFullscreen()">전체화면</button>
  <button class="exit-fullscreen-btn" onclick="exitFullscreen()">✕</button>

  <!-- 이유 입력 다이얼로그 -->
  <div id="reasonOverlay" class="dialog-overlay" hidden>
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="reasonTitle">
      <div class="dialog-title" id="reasonTitle">어떤 이유인가요?</div>
      <textarea id="reasonInput" placeholder="예: 병원 예약, 상담, 급한 용무 등" rows="4" style="font-size: 24px;"></textarea>
      <div class="actions">
        <button id="reasonCancel" type="button">취소</button>
        <button id="reasonSave" class="primary" type="button">저장</button>
      </div>
    </div>
  </div>

  <script>
    /* ===================== 고정 격자 좌표/자리표 ===================== */
    const gridPos = {};                  // 번호 -> {left, top}
    const placeholders = new Map();      // 번호 -> 자리표 엘리먼트

    function createPlaceholder(num) {
      if (placeholders.has(num)) return;
      const pos = gridPos[num];
      if (!pos) return;
      const p = document.createElement('div');
      p.className = 'magnet placeholder';
      p.textContent = num;
      p.style.left = pos.left + 'px';
      p.style.top  = pos.top  + 'px';
      p.style.background = 'linear-gradient(135deg,#666,#444)';
      p.style.opacity = '0.5';
      p.style.cursor = 'default';
      p.style.pointerEvents = 'none';
      p.style.boxShadow = 'none';
      document.getElementById('magnetContainer').appendChild(p);
      placeholders.set(num, p);
    }
    function removePlaceholder(num) {
      const p = placeholders.get(num);
      if (p) { p.remove(); placeholders.delete(num); }
    }

    /* ===================== 자석 생성 ===================== */
    function createMagnets() {
    const container = document.getElementById('magnetContainer');
    const rows = 6, cols = 5, size = 50, gap = 15;
    let n = 1;
  
    // 번호대별 색상 클래스 선택
    function getColorClass(num) {
      if (num >= 1 && num <= 5)   return 'color-red';
      if (num >= 6 && num <= 10)  return 'color-orange';
      if (num >= 11 && num <= 16) return 'color-yellow';
      if (num >= 17 && num <= 21) return 'color-green';
      if (num >= 21 && num <= 26) return 'color-blue';
      if (num >= 27 && num <= 31) return 'color-purple';
      return '';
    }
  
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        if (n > 31) break;
        if (n === 12) { n++; if (n > 31) break; } // 12번 건너뛰기
  
        const x = c * (size + gap) + 50;
        const y = r * (size + gap) + 500;
        gridPos[n] = { left: x, top: y };
  
        const m = document.createElement('div');
        m.className = 'magnet';
        const colorClass = getColorClass(n);
        if (colorClass) m.classList.add(colorClass);
  
        m.textContent = n;
        m.dataset.number = n;
        m.style.left = x + 'px';
        m.style.top  = y + 'px';
  
        container.appendChild(m);
        addDragFunctionality(m);
        n++;
      }
    }
  
    // 자리표 제외한 실제 총원 표기
    const total = container.querySelectorAll('.magnet:not(.placeholder)').length;
    const tc = document.getElementById('total-count');
    if (tc) tc.textContent = `${total}명`;
  
    updateMagnetOutline();
  }

    /* ===================== 외곽선(자리표 제외) ===================== */
    function ensureMagnetOutline() {
      const container = document.getElementById('magnetContainer');
      let outline = document.getElementById('magnetOutline');
      if (!outline) {
        outline = document.createElement('div');
        outline.id = 'magnetOutline';
        outline.className = 'magnet-outline';
        container.appendChild(outline);
      }
      return outline;
    }

    function updateMagnetOutline() {
      const container = document.getElementById('magnetContainer');
      const outline = ensureMagnetOutline();
      // ✅ 자리표도 포함해서 테두리 계산
      const nodes = container.querySelectorAll('.magnet:not(.attached)');

      if (!nodes.length) {
        outline.style.display = 'none';
        return;
      }

      let minL = Infinity, minT = Infinity, maxR = -Infinity, maxB = -Infinity;
      nodes.forEach(m => {
        const left = parseFloat(m.style.left) || 0;
        const top  = parseFloat(m.style.top)  || 0;
        const w = m.offsetWidth  || 50;
        const h = m.offsetHeight || 50;
        minL = Math.min(minL, left);
        minT = Math.min(minT, top);
        maxR = Math.max(maxR, left + w);
        maxB = Math.max(maxB, top  + h);
      });

      const pad = 8;
      outline.style.display = 'block';
      outline.style.left   = (minL - pad) + 'px';
      outline.style.top    = (minT - pad) + 'px';
      outline.style.width  = (maxR - minL + pad * 2) + 'px';
      outline.style.height = (maxB - minT + pad * 2) + 'px';
    }

    /* ===================== 출결 계산 ===================== */
    function updateAttendance() {
      // 자리표(.placeholder) 제외한 실제 학생만 집계
      const total = document.querySelectorAll('.magnet:not(.placeholder)').length;
    
      // 화장실/복도를 결원에서 제외하려면 그대로 두고,
      // 결원에 포함시키려면 [] 로 바꾸세요.
      const excluded = new Set(['toilet', 'hallway']);
    
      let absentCount = 0;
      document.querySelectorAll('.board-section').forEach(section => {
        const cat = section.dataset.category;
        const content = section.querySelector('.section-content');
        if (!content) return;
    
        const n = content.querySelectorAll('.magnet:not(.placeholder)').length;
        if (!excluded.has(cat)) absentCount += n;
      });
    
      // 표기값도 항상 동기화
      document.getElementById('total-count').textContent   = `${total}명`;
      document.getElementById('absent-count').textContent  = `${absentCount}명`;
      document.getElementById('present-count').textContent = `${total - absentCount}명`;
    }

    /* ===================== 섹션 정렬(번호순) & 기타 사유 패널 ===================== */
    function sortSection(contentEl) {
      const mags = Array.from(contentEl.querySelectorAll('.magnet'))
        .sort((a, b) => (+a.dataset.number) - (+b.dataset.number));
      mags.forEach(m => contentEl.appendChild(m));
    }
    function sortAllSections() {
      document.querySelectorAll('.section-content').forEach(sortSection);
    }

    function updateEtcReasonPanel() {
      const list = document.getElementById('reasonList');
      if (!list) return;

      const etcContent = document.querySelector('[data-category="etc"] .section-content');
      const items = etcContent ? Array.from(etcContent.querySelectorAll('.magnet'))
                                .sort((a,b)=> (+a.dataset.number) - (+b.dataset.number))
                               : [];

      list.innerHTML = '';
      if (!items.length) {
        const empty = document.createElement('div');
        empty.textContent = '현재 등록된 기타 사유가 없습니다.';
        empty.style.opacity = '0.7';
        list.appendChild(empty);
        return;
      }

      items.forEach(m => {
        const num = m.dataset.number;
        const reason = m.dataset.reason || '(이유 미입력)';
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.gap = '8px';
        row.style.alignItems = 'flex-start';

        const badge = document.createElement('span');
        badge.textContent = num;
        badge.style.minWidth = '28px';
        badge.style.height = '28px';
        badge.style.borderRadius = '50%';
        badge.style.display = 'grid';
        badge.style.placeItems = 'center';
        badge.style.background = '#ff3e3e';
        badge.style.color = '#fff';
        badge.style.fontWeight = '700';

        const text = document.createElement('div');
        text.textContent = reason;
        text.style.flex = '1';

        row.appendChild(badge);
        row.appendChild(text);
        list.appendChild(row);
      });
    }

    /* ===================== 유틸: 원래 자리로 스냅 ===================== */
    function snapToHome(el) {
      const pos = gridPos[+el.dataset.number];
      if (!pos) return;
      el.style.left = pos.left + 'px';
      el.style.top  = pos.top  + 'px';
      el.style.transform = 'translate(0,0)';
    }

    /* ===================== 드래그 ===================== */
    function addDragFunctionality(el) {
      let isDragging = false;
      let currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;

      function dragStart(e) {
        // 섹션에 붙어 있으면 컨테이너에 떼어내되, 화면상 같은 좌표로 절대배치(스냅하지 않음)
        if (el.classList.contains('attached')) {
          const rect = el.getBoundingClientRect();
          const container = document.getElementById('magnetContainer');
          const containerRect = container.getBoundingClientRect();

          el.classList.remove('attached');
          container.appendChild(el);

          el.style.left = (rect.left - containerRect.left) + 'px';
          el.style.top  = (rect.top  - containerRect.top)  + 'px';
          el.style.transform = 'translate(0,0)';
          // 이유는 드롭 결과가 '기타'가 아닐 때만 지울 것임(여기서는 유지)

          // 자리표는 계속 유지(집에 없으니까)
          updateAttendance();
          updateMagnetOutline();
          updateEtcReasonPanel();
        }

        if (e.type === "touchstart") {
          initialX = e.touches[0].clientX - xOffset;
          initialY = e.touches[0].clientY - yOffset;
        } else {
          initialX = e.clientX - xOffset;
          initialY = e.clientY - yOffset;
        }

        if (e.target === el) {
          isDragging = true;
          el.classList.add('dragging');
        }
      }

      function drag(e) {
        if (!isDragging) return;
        e.preventDefault();

        if (e.type === "touchmove") {
          currentX = e.touches[0].clientX - initialX;
          currentY = e.touches[0].clientY - initialY;
        } else {
          currentX = e.clientX - initialX;
          currentY = e.clientY - initialY;
        }

        xOffset = currentX;
        yOffset = currentY;

        if (!el.classList.contains('attached')) {
          const container = document.getElementById('magnetContainer');
          const containerRect = container.getBoundingClientRect();

          const curL = parseFloat(el.style.left) || 0;
          const curT = parseFloat(el.style.top)  || 0;

          let newX = curL + currentX;
          let newY = curT + currentY;

          if (newX < 0) newX = 0;
          if (newY < 0) newY = 0;
          if (newX > containerRect.width  - el.offsetWidth)  newX = containerRect.width  - el.offsetWidth;
          if (newY > containerRect.height - el.offsetHeight) newY = containerRect.height - el.offsetHeight;

          el.style.left = newX + 'px';
          el.style.top  = newY + 'px';
          el.style.transform = 'translate(0,0)';

          initialX = e.type === "touchmove" ? e.touches[0].clientX : e.clientX;
          initialY = e.type === "touchmove" ? e.touches[0].clientY : e.clientY;
          xOffset = 0; yOffset = 0;

          updateMagnetOutline();
        } else {
          el.style.transform = `translate(${currentX}px, ${currentY}px)`;
        }

        // 드롭존 하이라이트
        const r = el.getBoundingClientRect();
        const cx = r.left + r.width / 2;
        const cy = r.top  + r.height / 2;
        document.querySelectorAll('.board-section').forEach(sec => {
          const sr = sec.getBoundingClientRect();
          if (cx >= sr.left && cx <= sr.right && cy >= sr.top && cy <= sr.bottom) {
            sec.classList.add('drag-over');
          } else {
            sec.classList.remove('drag-over');
          }
        });
      }

      function dragEnd() {
        if (!isDragging) return;
        isDragging = false;
        el.classList.remove('dragging');

        const r = el.getBoundingClientRect();
        const cx = r.left + r.width / 2;
        const cy = r.top  + r.height / 2;

        let targetSection = null;
        document.querySelectorAll('.board-section').forEach(sec => {
          const sr = sec.getBoundingClientRect();
          if (cx >= sr.left && cx <= sr.right && cy >= sr.top && cy <= sr.bottom) {
            targetSection = sec;
          }
        });

        if (targetSection) {
          const content = targetSection.querySelector('.section-content');
          el.classList.add('attached');
          el.style.transform = '';
          el.style.left = '';
          el.style.top  = '';
          content.appendChild(el);

          // 번호순 정렬
          sortSection(content);

          // 기타면 이유 입력(없으면 물어봄), 아니면 이유 제거
          if (targetSection.dataset.category === 'etc') {
            if (!el.dataset.reason) openReasonDialog(el);
          } else {
            if (el.dataset.reason) {
              delete el.dataset.reason;
              el.classList.remove('has-reason');
            }
          }

          // 집을 비웠으니 자리표 유지/생성
          createPlaceholder(+el.dataset.number);
        } else {
          // 섹션이 아니면 항상 원래 자리로 복귀 + 이유 제거 + 자리표 제거
          snapToHome(el);
          if (el.dataset.reason) {
            delete el.dataset.reason;
            el.classList.remove('has-reason');
          }
          removePlaceholder(+el.dataset.number);
        }

        updateAttendance();
        updateMagnetOutline();
        updateEtcReasonPanel();

        document.querySelectorAll('.board-section').forEach(sec => sec.classList.remove('drag-over'));
      }

      el.addEventListener('mousedown', dragStart);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', dragEnd);

      el.addEventListener('touchstart', dragStart, { passive: false });
      document.addEventListener('touchmove', drag, { passive: false });
      document.addEventListener('touchend', dragEnd);
    }

    /* ===================== 이유 모달 ===================== */
    let currentReasonTarget = null;

    function openReasonDialog(target) {
      currentReasonTarget = target;
      const overlay = document.getElementById('reasonOverlay');
      const input = document.getElementById('reasonInput');
      input.value = target.dataset.reason || "";
      overlay.hidden = false;
      setTimeout(() => input.focus(), 0);
    }

    function closeReasonDialog() {
      document.getElementById('reasonOverlay').hidden = true;
      currentReasonTarget = null;
    }

    document.getElementById('reasonSave').addEventListener('click', () => {
      const input = document.getElementById('reasonInput');
      const text = input.value.trim();
      if (currentReasonTarget) {
        if (text) {
          currentReasonTarget.dataset.reason = text;
          currentReasonTarget.classList.add('has-reason');
        } else {
          delete currentReasonTarget.dataset.reason;
          currentReasonTarget.classList.remove('has-reason');
        }
      }
      closeReasonDialog();
      sortAllSections();
      updateEtcReasonPanel();
    });

    document.getElementById('reasonCancel').addEventListener('click', () => {
      closeReasonDialog();
      updateEtcReasonPanel();
    });

    document.getElementById('reasonOverlay').addEventListener('mousedown', (e) => {
      if (e.target.id === 'reasonOverlay') {
        closeReasonDialog();
        updateEtcReasonPanel();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !document.getElementById('reasonOverlay').hidden) {
        closeReasonDialog();
        updateEtcReasonPanel();
      }
    });

    /* ===================== 전체화면/시계 ===================== */
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().then(() => {
          document.body.classList.add('fullscreen');
        }).catch(()=>{});
      }
    }
    function exitFullscreen() {
      if (document.fullscreenElement) {
        document.exitFullscreen().then(() => {
          document.body.classList.remove('fullscreen');
        }).catch(()=>{});
      }
    }
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) document.body.classList.remove('fullscreen');
    });

    function updateClock() {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
      document.getElementById('hours').textContent = h;
      document.getElementById('minutes').textContent = m;
      document.getElementById('seconds').textContent = s;

      const days = ['일요일','월요일','화요일','수요일','목요일','금요일','토요일'];
      const months = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
      document.getElementById('date').textContent =
        `${months[now.getMonth()]} ${now.getDate()}일 ${days[now.getDay()]}`;
      tstat = document.getElementById('tstat');
      if ((h < 8 || (h == 8 && m < 10)) {
          tstat.textContent = '아침 시간';
      } else if (h == 8 && m >= 10 && m < 50) {
          tstat.textContent = '아침 자습';
      }else if ((h == 17 && (m >= 10 && m < 50)) {
          tstat.textContent = '방과후 1타임';
      } else if (h == 17 && (m >= 50 && m < 55)) {
        tstat.textContent = '쉬는 시간';
      } else if ((h == 17 && m >= 55) || (h == 18 && m < 35)) {
          tstat.textContent = '방과후 2타임';
      } else if ((h == 18 && m >= 35) || (h == 19 && m < 50)) {
          tstat.textContent = '저녁 시간';
      } else if ((h == 19 && m >= 50) || h == 20 || (h == 21 && m < 10)) {
          tstat.textContent = '야자 1타임';
      } else if ((h == 21 && m >= 10 && m < 30)) {
          tstat.textContent = '쉬는 시간';
      } else if ((h == 21 && m >= 30) || (h == 22 && m < 50)) {
          tstat.textContent = '야자 2타임';
      } else if ((h == 22 && m == 49)) {
          if (s >= 50) {
              tstat.textContent = 60 - s;
          }
      } else if ((h == 22 && m == 49)) {
          tstat.textContent = '끝.';
      }
      const hoursDeg = (now.getHours() % 12) * 30 + (now.getMinutes() * 0.5);
      const minutesDeg = now.getMinutes() * 6 + (now.getSeconds() * 0.1);
      const secondsDeg = now.getSeconds() * 6;
      document.getElementById('hourHand').style.transform   = `translateX(-50%) rotate(${hoursDeg      }deg)`;
      document.getElementById('minuteHand').style.transform = `translateX(-50%) rotate(${minutesDeg}deg)`;
      document.getElementById('secondHand').style.transform = `translateX(-50%) rotate(${secondsDeg}deg)`;
    }

    // 초기화
    createMagnets();
    updateAttendance();
    updateEtcReasonPanel();
    updateClock();
    setInterval(updateClock, 1000);
    setTimeout(() => {
      const sh = document.getElementById('secondHand');
      if (sh) sh.style.transition = 'transform 0.5s cubic-bezier(0.4, 0.0, 0.2, 1)';
    }, 1000);
  </script>
</body>
</html>
